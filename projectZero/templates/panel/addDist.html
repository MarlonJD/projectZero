{% extends 'panel/layout.html' %}
{% load i18n %}
{% load static %}
{% block title %}Home{% endblock %}

{% block content %}
<div class="page-header">
    <h3 class="page-title">
        <span class="page-title-icon bg-gradient-primary text-white mr-2">
            <i class="mdi mdi-home"></i>
        </span> {% trans 'Distribution' %}</h3>
    <nav aria-label="breadcrumb">
        <ul class="breadcrumb">
            <li class="breadcrumb-item active" aria-current="page">
                <a class="btn btn-sm btn-gradient-primary" href="{% url 'panel:addDist' %}"><i class="mdi mdi-plus"></i>New Distribution</a>
            </li>
        </ul>
    </nav>
</div>

<div class="row" id="app">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">New Distribution</h4>
                <p class="card-description"> Please fill required fields for create distirbution
                </p>
		<div class="multi-step checked">
		    <ul class="multi-step-list">
			<li class="multi-step-item active" @click="step = 1" v-bind:class="{current: step === 1, completed: step === 2 | step === 3 | step === 4 & error1 === false , error: error1 }">
			    <div class="item-wrap">
				<p class="item-title">Step One</p>
				<p class="item-subtitle">Tracks</p>
			    </div>
			</li>
			<li class="multi-step-item active" @click="step = 2" v-bind:class="{current: step === 2, completed: step === 3 | step === 4 & error2 === false , error: error2 }">
			    <div class="item-wrap">
				<p class="item-title">Step Two</p>
				<p class="item-subtitle">Details</p>
			    </div>
			</li>
			<li class="multi-step-item active" @click="step = 3" v-bind:class="{current: step === 3, completed: step === 4 & error3 === false , error: error3}">
			    <div class="item-wrap">
				<p class="item-title">Step Three</p>
				<p class="item-subtitle">Partners</p>
			    </div>
			</li>
			<li class="multi-step-item active" @click="step = 4" v-bind:class="{current: step === 4 & error4 === false , error: error4}">
			    <div class="item-wrap">
				<p class="item-title">Step Four</p>
				<p class="item-subtitle">Preview</p>
			    </div>
			</li>
		    </ul>
		</div>

		<div v-if="step === 1">
		    <div class="card mb-4">
			<div class="card-body">
			    <h5 class="card-title">Tracks
				<a href="#" v-b-modal.modal-prevent-closing class="btn btn-sm btn-gradient-info float-right">
				    <i class="mdi mdi-plus"></i>Add Track
				</a>
			    </h5>
			    <h6 class="card-subtitle mb-2 text-muted">Please add your tracks</h6>
			    <div v-if="filesLoad.length > 0">
				<b-table striped hover :items="filesLoad"></b-table>
			    </div>
			    <div v-else>
				<div class="alert alert-warning" role="alert">
				    {% trans 'Any tracks here yet. Please add any track with button' %}
				</div>
			    </div>
			    
			</div>
		    </div>

		    <b-modal
			id="modal-prevent-closing"
			ref="modal"
			title="Add Track"
			@show="resetModal"
			@hidden="resetModal"
			    @ok="handleOk"
		    >
			<form ref="form" @submit.stop.prevent="handleSubmit">
			    <div class="form-group">
				<label for="number">Track Number</label>
				<input type="number" class="form-control" id="number" name="number" aria-describedby="numberHelp">
				<small id="numberHelp" class="form-text text-muted">This is the album track number</small>
			    </div>
			    <div class="form-group">
				<label for="name">Track Title</label>
				<input type="text" class="form-control" id="name" name="name">
			    </div>

			    <div class="form-group">
				<label for="name">Media File</label>
				<b-form-file
				    lang="{% get_current_language as LANG_CODE %}{{LANG_CODE}}"
				    id="media"
				    name="media"
				    v-model="files"
				    placeholder="{% trans 'Choose...' %}"
				    drop-placeholder="{% trans 'Drop file here...' %}"
				    accept="audio/*, video/*"
				    multiple>
				    <template slot="file-name" slot-scope="{ names }">
					<b-badge>[[ names[0] ]]</b-badge>
													<b-badge v-if="names.length > 1" class="ml-1">
													+ [[ names.length - 1 ]] {% trans 'More files' %}
					</b-badge>
				    </template>
				</b-form-file>
												    </div>

			    <div class="form-group">
				<label for="name">Split Pay</label>
				<table class="table col">
				    <tbody>
					<tr v-for="(row, index) in rows">
					    <td><b-form-input id="input-small" size="sm" v-model="row.email" placeholder="Email"></b-form-input></td>
					    <td><b-form-input id="input-small" size="sm" v-model="row.rate" min=1 max=100 type="number" placeholder="Rate"></b-form-input></td>
					    <td>
						<a class="btn btn-info text-white btn-sm" @click="removeElement(index);" style="cursor: pointer">
						    <i class="mdi mdi-playlist-remove"></i>
						</a>
						<a class="btn btn-info text-white btn-sm" @click="addRow" style="cursor: pointer">
						    <i class="mdi mdi-plus"></i>
						</a>
					    </td>
					</tr>
				    </tbody>
				</table>
			    </div>

			</form>
		    </b-modal>
		    <button class="float-right btn-lg btn-gradient-primary" @click.prevent="next()">Next</button>
		</div>
		
		<div v-if="step === 2">
		    <button class="float-left btn-lg btn-gradient-danger" @click.prevent="prev()">Previous</button>
		    <button class="float-right btn-lg btn-gradient-primary" @click.prevent="next()">Next</button>
		</div>
		<div v-if="step === 3">
		    <button class="float-left btn-lg btn-gradient-danger" @click.prevent="prev()">Previous</button>
		    <button class="float-right btn-lg btn-gradient-primary" @click.prevent="next()">Next</button>
		</div>
		<div v-if="step === 4">
		    <button class="float-left btn-lg btn-gradient-danger" @click.prevent="prev()">Previous</button>
		    <button class="float-right btn-lg btn-gradient-success" @click.prevent="submit()">Save</button>
		</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
 Vue.directive('$model', {
     bind: function (el, binding, vnode) {
	 el.oninput = () => (vnode.context[binding.expression] = el.value)
     }
 })
 
 app = new Vue({
     delimiters: ['[[', ']]'],
     el: '#app',
     data: {
	 step: 1,
	 error1: false,
	 error2: false,
	 error3: false,
	 error4: false,
	 files: null,
	 filesLoading: [],
	 filesLoad: [],
	 name: '',
         nameState: null,
         submittedNames: [],
	 rows: [
	     {
		 email: null,
		 rate: null,
	     }
	 ],
     },
     mounted() {
	 
     },
     methods: {
	 prev() {
	     this.step--;
	 },
	 next() {
	     this.step++;
	 },
	 checkFormValidity() {
             const valid = this.$refs.form.checkValidity()
             this.nameState = valid ? 'valid' : 'invalid'
             return valid
	 },
	 resetModal() {
             this.name = ''
             this.nameState = null
	     this.rows = [
		 {
		     email: null,
		     rate: null,
		 }
	     ]
	 },
	 handleOk(bvModalEvt) {
             // Prevent modal from closing
             bvModalEvt.preventDefault()
             // Trigger submit handler
             this.handleSubmit()
	 },
	 handleSubmit() {
             // Exit when the form isn't valid
             if (!this.checkFormValidity()) {
		 return
             }
             // Push the name to submitted names

	     this.filesLoading = []

	     var form = this.$refs["form"]
	     var formData = new FormData(form);
	     
	     axios
		 .post('/trackUpload',formData,{
		     headers: {
			 'Content-Type': 'multipart/form-data'
		     }
		 })
		 .then(response => {
		     console.log(JSON.stringify(response.data));
		     this.filesLoad.push(response.data);
		     this.makeToast('success', 'Success', "File successfully uploaded");
		 })
		 .catch(error => {
		     console.log(error)
		     this.makeToast('danger', 'Error', error.response.data.Message);
		     return false
		 })
             // Hide the modal manually
             this.$nextTick(() => {
		 this.$refs.modal.hide()
             })
	 },
	 addRow: function() {
             var elem = document.createElement('tr');
	     
             this.rows.push({
                 email: "",
		 rate: 0,
             });
         },
         removeElement: function(index) {
	     if (this.rows.length > 1) {
		 this.rows.splice(index, 1);
	     }
         },
     },
     computed: {
	 filteredItems() {
	     return this.items.filter(item => {
		 return item.name.toLowerCase().indexOf(this.filter.toLowerCase()) > -1
	     })
	 }
     },
 })
</script>
{% endblock %}
